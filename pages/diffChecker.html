<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevUtils - Advanced Git Diff</title>
    
    <!-- Library: jsdiff -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>

    <style>
        /* --- 1. THEME VARIABLES --- */
        :root {
            --bg-dark: #1e1e1e; /* VS Code Dark */
            --bg-panel: #252526;
            --text-main: #cccccc;
            --text-muted: #858585;
            --border: #3e3e42;
            
            --jwt-blue: #007acc; /* VS Code Blue */
            
            /* LINE Backgrounds (Subtle) */
            --diff-add-bg: rgba(72, 126, 2, 0.2);
            --diff-del-bg: rgba(255, 0, 0, 0.2);
            
            /* WORD/CHAR Highlights (Stronger) */
            --diff-add-token: rgba(72, 126, 2, 0.6);
            --diff-del-token: rgba(255, 0, 0, 0.5);

            --gutter-bg: #1e1e1e;
            --gutter-text: #858585;
            --gutter-border: #2b2b2b;
            
            --code-font: 'Menlo', 'Monaco', 'Courier New', monospace;
        }

        [data-theme=light] {
            --bg-dark: #ffffff;
            --bg-panel: #f3f3f3;
            --text-main: #24292f;
            --text-muted: #6e7781;
            --border: #e1e4e8;
            
            --diff-add-bg: #e6ffec;
            --diff-del-bg: #ffebe9;
            
            --diff-add-token: #abf2bc;
            --diff-del-token: #ffc1c0;

            --gutter-bg: #ffffff;
            --gutter-text: #6e7781;
            --gutter-border: #e1e4e8;
        }

        /* --- 2. LAYOUT --- */
        * { box-sizing: border-box; outline: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: var(--text-main); background-color: var(--bg-dark); margin: 0; height: 100vh; overflow: hidden; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: var(--bg-panel); border-bottom: 1px solid var(--border); height: 50px; }
        .logo { font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; }
        .icon-btn { cursor: pointer; opacity: 0.7; font-size: 1.1rem; }
        .icon-btn:hover { opacity: 1; }

        /* Main Split */
        .workspace { display: flex; height: calc(100vh - 50px); flex-direction: column; }
        
        /* Inputs Area */
        .inputs-row { display: flex; height: 30%; border-bottom: 1px solid var(--border); }
        .input-col { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .input-col:last-child { border-right: none; }
        
        .col-header { padding: 5px 15px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--text-muted); background: var(--bg-panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;}
        
        textarea { 
            flex: 1; resize: none; border: none; padding: 10px; 
            background: var(--bg-dark); color: var(--text-main); 
            font-family: var(--code-font); font-size: 13px; line-height: 1.5;
        }
        
        /* Action Bar */
        .action-bar { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
        .run-btn { background: var(--jwt-blue); color: white; border: none; padding: 4px 12px; border-radius: 2px; font-size: 0.8rem; cursor: pointer; font-weight: 500; }
        .run-btn:hover { opacity: 0.9; }

        /* Diff Viewer */
        .diff-container { flex: 1; overflow: auto; background: var(--bg-dark); position: relative; }
        
        /* Table Styles */
        .diff-table { width: 100%; border-collapse: collapse; table-layout: fixed; font-family: var(--code-font); font-size: 13px; }
        .diff-table td { padding: 0; vertical-align: top; line-height: 20px; white-space: pre-wrap; word-break: break-all; height: 20px; }
        
        /* Specific Column Styles */
        .num-col { 
            width: 50px; text-align: right; padding-right: 10px !important; 
            color: var(--gutter-text); background: var(--gutter-bg); 
            border-right: 1px solid var(--gutter-border); user-select: none; 
            opacity: 0.7;
        }
        .code-col { padding-left: 10px !important; width: calc(50% - 50px); }
        
        /* State Colors */
        .line-del { background-color: var(--diff-del-bg); }
        .line-add { background-color: var(--diff-add-bg); }
        
        /* Intra-line highlights (VS Code Style) */
        .token-del { background-color: var(--diff-del-token); border-radius: 1px; }
        .token-add { background-color: var(--diff-add-token); border-radius: 1px; }
        
        .empty-gutter { background: var(--gutter-bg); }
        .empty-code { background: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(0,0,0,0.05) 5px, rgba(0,0,0,0.05) 10px); }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 12px; height: 12px; background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #424242; border-radius: 6px; border: 3px solid var(--bg-dark); }
        ::-webkit-scrollbar-corner { background: transparent; }

    </style>
</head>
<body>

    <header>
        <div class="logo">
            <span>DIFF EDITOR</span>
        </div>
        
        <div class="action-bar">
            <button class="run-btn" onclick="computeAdvancedDiff()">Update Diff</button>
        </div>

        <div class="icon-btn" id="themeToggle">â—‘</div>
    </header>

    <div class="workspace">
        
        <!-- Inputs -->
        <div class="inputs-row">
            <div class="input-col">
                <div class="col-header">Original</div>
                <textarea id="originalInput" spellcheck="false" oninput="debounceDiff()">const price = 100;
function calculateTotal() {
  return price * 1.20;
}</textarea>
            </div>
            <div class="input-col">
                <div class="col-header">Modified</div>
                <textarea id="modifiedInput" spellcheck="false" oninput="debounceDiff()">const price = 150;
function calculateTotal() {
  // Added tax rate
  return price * 1.25; 
}</textarea>
            </div>
        </div>

        <!-- Output -->
        <div class="diff-container">
            <table class="diff-table" id="diffTable">
                <!-- Diff Rows Injected Here -->
            </table>
        </div>

    </div>

    <script>
        // --- 1. ADVANCED DIFF LOGIC ---
        
        function computeAdvancedDiff() {
            const text1 = document.getElementById('originalInput').value;
            const text2 = document.getElementById('modifiedInput').value;
            const table = document.getElementById('diffTable');
            
            // 1. Get Line-by-Line Diff
            const diffs = Diff.diffLines(text1, text2);
            
            table.innerHTML = "";
            let leftNum = 1;
            let rightNum = 1;
            
            // We process the diff array to pair up "Removed" blocks with immediately following "Added" blocks
            // to detect "Modifications" vs "Deletions/Insertions".
            
            for (let i = 0; i < diffs.length; i++) {
                const part = diffs[i];
                
                // --- CASE A: Unchanged ---
                if (!part.added && !part.removed) {
                    const lines = part.value.split('\n');
                    if (lines[lines.length - 1] === '') lines.pop();
                    
                    lines.forEach(line => {
                        renderRow(leftNum, rightNum, line, line, 'normal');
                        leftNum++;
                        rightNum++;
                    });
                    continue;
                }
                
                // --- CASE B: Modification (Remove followed by Add) ---
                // We check if the NEXT part exists and is an 'added' part
                if (part.removed && diffs[i+1] && diffs[i+1].added) {
                    const nextPart = diffs[i+1];
                    
                    const remLines = part.value.split('\n');
                    if (remLines[remLines.length - 1] === '') remLines.pop();
                    
                    const addLines = nextPart.value.split('\n');
                    if (addLines[addLines.length - 1] === '') addLines.pop();
                    
                    // We pair them up line-by-line up to the minimum length
                    const count = Math.max(remLines.length, addLines.length);
                    
                    for(let j = 0; j < count; j++) {
                        const remLine = remLines[j];
                        const addLine = addLines[j];
                        
                        if (remLine !== undefined && addLine !== undefined) {
                            // *** INTRA-LINE DIFF *** 
                            // Compute char-level diffs for this specific line pair
                            const charDiffs = Diff.diffWordsWithSpace(remLine, addLine);
                            
                            let leftHTML = "";
                            let rightHTML = "";
                            
                            charDiffs.forEach(change => {
                                const esc = escapeHtml(change.value);
                                if(change.removed) {
                                    leftHTML += `<span class="token-del">${esc}</span>`;
                                } else if(change.added) {
                                    rightHTML += `<span class="token-add">${esc}</span>`;
                                } else {
                                    leftHTML += esc;
                                    rightHTML += esc;
                                }
                            });
                            
                            renderRow(leftNum, rightNum, leftHTML, rightHTML, 'modified');
                            leftNum++;
                            rightNum++;

                        } else if (remLine !== undefined) {
                            // Extra removed lines
                            renderRow(leftNum, null, remLine, "", 'removed');
                            leftNum++;
                        } else {
                            // Extra added lines
                            renderRow(null, rightNum, "", addLine, 'added');
                            rightNum++;
                        }
                    }
                    
                    // Skip the next part since we processed it
                    i++; 
                    
                } 
                // --- CASE C: Pure Removal ---
                else if (part.removed) {
                    const lines = part.value.split('\n');
                    if (lines[lines.length - 1] === '') lines.pop();
                    lines.forEach(line => {
                        renderRow(leftNum, null, line, "", 'removed');
                        leftNum++;
                    });
                }
                // --- CASE D: Pure Addition ---
                else if (part.added) {
                    const lines = part.value.split('\n');
                    if (lines[lines.length - 1] === '') lines.pop();
                    lines.forEach(line => {
                        renderRow(null, rightNum, "", line, 'added');
                        rightNum++;
                    });
                }
            }
        }

        // --- 2. RENDER HELPER ---
        function renderRow(lNum, rNum, lContent, rContent, type) {
            const table = document.getElementById('diffTable');
            const row = document.createElement('tr');
            
            // Classes
            let lClass = "code-col";
            let rClass = "code-col";
            
            if(type === 'removed') lClass += " line-del";
            if(type === 'added') rClass += " line-add";
            if(type === 'modified') {
                lClass += " line-del";
                rClass += " line-add";
            }

            // Left Side
            let leftHTML = '';
            if (lNum !== null) {
                leftHTML = `<td class="num-col">${lNum}</td><td class="${lClass}">${type === 'normal' || type === 'removed' ? escapeHtml(lContent) : lContent}</td>`;
            } else {
                leftHTML = `<td class="num-col empty-gutter"></td><td class="code-col empty-code"></td>`;
            }

            // Right Side
            let rightHTML = '';
            if (rNum !== null) {
                rightHTML = `<td class="num-col">${rNum}</td><td class="${rClass}">${type === 'normal' || type === 'added' ? escapeHtml(rContent) : rContent}</td>`;
            } else {
                rightHTML = `<td class="num-col empty-gutter"></td><td class="code-col empty-code"></td>`;
            }

            row.innerHTML = leftHTML + rightHTML;
            table.appendChild(row);
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                       .replace(/"/g, "&quot;").replace(/'/g, "&#039;").replace(/\t/g, "    ");
        }

        // --- 3. UTILS & EVENTS ---
        let debounceTimer;
        function debounceDiff() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(computeAdvancedDiff, 300);
        }

        const themeToggle = document.getElementById('themeToggle');
        if(localStorage.getItem('theme') === 'light') document.body.setAttribute('data-theme', 'light');
        themeToggle.addEventListener('click', () => {
            if (document.body.getAttribute('data-theme') === 'light') {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
        });

        // Init
        computeAdvancedDiff();

    </script>
</body>
</html>
