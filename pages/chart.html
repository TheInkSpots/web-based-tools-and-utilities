<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libra Analytics | Professional Report</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary: #7B9ACC; /* Libra Blue */
            --secondary: #E0B0B0; /* Soft Rose */
            --danger: #E57373;
            --dark: #2C3E50;
            --light: #F5F7FA;
            --white: #FFFFFF;
            --shadow: 0 10px 30px rgba(123, 154, 204, 0.15);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        /* Header with Export Button */
        header {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .header-title h1 {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--primary);
        }

        .header-title p {
            color: #7F8C8D;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-pdf {
            background-color: var(--dark);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-family: 'Lato', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-pdf:hover {
            background-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Main Grid */
        .container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            max-width: 1200px;
            width: 100%;
            /* Required for PDF capture background */
            background-color: var(--light); 
        }

        /* Common Card Style */
        .card {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        /* Left Control Panel */
        .controls-card {
            border-top: 4px solid var(--primary);
            height: fit-content;
        }

        h2 { font-family: 'Cinzel', serif; font-size: 1.2rem; margin-bottom: 1.5rem; }

        .input-group { margin-bottom: 1.2rem; }
        
        label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #7F8C8D;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #E0E0E0;
            border-radius: 6px;
            font-family: 'Lato', sans-serif;
            font-size: 1rem;
        }
        input:focus { outline: none; border-color: var(--primary); }

        .btn-group { display: flex; gap: 10px; margin-top: 1rem; }

        button {
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        .btn-add { flex: 1; background-color: var(--primary); color: white; }
        .btn-clear { flex: 1; background-color: transparent; border: 1px solid var(--secondary); color: var(--secondary); }
        button:hover { opacity: 0.85; }

        /* List Items */
        .data-list { margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1rem; }
        
        .data-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 8px 12px; 
            margin-bottom: 6px;
            background: #FAFAFA;
            border-radius: 6px;
            border: 1px solid #eee;
            font-size: 0.9rem;
        }

        .btn-remove {
            background: none;
            color: var(--danger);
            border: 1px solid #ffebee;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
        }
        .btn-remove:hover { background-color: var(--danger); color: white; border-color: var(--danger); }

        /* Chart Area */
        .chart-card {
            border-top: 4px solid var(--secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 500px;
        }

        .chart-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        
        .toggle-switch button {
            padding: 5px 12px;
            font-size: 0.75rem;
            background: #eee;
            color: #555;
            margin-left: 5px;
        }
        
        .stats-summary { margin-top: 20px; text-align: center; font-size: 1rem; line-height: 1.5; }
        .stats-summary span { font-weight: bold; color: var(--primary); }

        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header id="topHeader">
        <div class="header-title">
            <h1>Libra Analytics</h1>
            <p>Balanced Data Visualization</p>
        </div>
        <button class="btn-pdf" onclick="exportPDF()">
            <span>Download PDF</span>
        </button>
    </header>

    <div class="container" id="dashboardContent">
        
        <div class="card controls-card">
            <h2>Data Input</h2>
            
            <div class="input-group">
                <label>Total Limit (Optional)</label>
                <input type="number" id="totalInput" placeholder="e.g. 1000" oninput="renderChart()">
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 1.5rem 0;">

            <div class="input-group">
                <label>Section Label</label>
                <input type="text" id="labelInput" placeholder="e.g. Budget A">
            </div>

            <div class="input-group">
                <label>Value</label>
                <input type="number" id="valueInput" placeholder="e.g. 250">
            </div>

            <div class="btn-group">
                <button class="btn-add" onclick="addEntry()">Add Entry</button>
                <button class="btn-clear" onclick="resetAll()">Reset</button>
            </div>

            <div class="data-list">
                <label>Breakdown</label>
                <div id="listContent" style="text-align:center; color:#ccc; margin-top:10px;">Empty</div>
            </div>
        </div>

        <div class="card chart-card">
            <div class="chart-header">
                <h2>Visualization</h2>
                <div class="toggle-switch">
                    <button onclick="toggleType('pie')">Pie</button>
                    <button onclick="toggleType('bar')">Bar</button>
                </div>
            </div>
            
            <div style="position: relative; height: 400px; width: 100%;">
                <canvas id="myChart"></canvas>
            </div>

            <div class="stats-summary" id="statsSummary">
                Enter data to begin.
            </div>
        </div>
    </div>

    <script>
        // --- 1. Configuration & State ---
        const libraPalette = ['#7B9ACC', '#E0B0B0', '#B0C4DE', '#D7BDE2', '#F9E79F', '#A2D9CE'];
        const undefinedColor = '#E0E0E0'; 
        let userEntries = { labels: [], values: [] };
        let chartInstance = null;
        let currentType = 'pie';

        // --- 2. Initialization ---
        window.onload = function() {
            const ctx = document.getElementById('myChart').getContext('2d');
            
            chartInstance = new Chart(ctx, {
                type: currentType,
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { family: 'Lato' }, padding: 20 } },
                        // --- HOVER PERCENTAGE LOGIC ---
                        tooltip: {
                            backgroundColor: 'rgba(44, 62, 80, 0.9)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    let value = context.raw;
                                    let totalInput = parseFloat(document.getElementById('totalInput').value);
                                    let totalDivisor;

                                    // If a Total Limit is defined by user, use that for %
                                    // If not, use the sum of all visible data
                                    if (!isNaN(totalInput) && totalInput > 0) {
                                        totalDivisor = totalInput;
                                    } else {
                                        // Calculate sum of current visible data
                                        totalDivisor = context.chart._metasets[context.datasetIndex].total;
                                    }

                                    let percentage = ((value / totalDivisor) * 100).toFixed(1) + '%';
                                    return ` ${label}: ${value} (${percentage})`;
                                }
                            }
                        }
                    },
                    animation: { duration: 800 }
                }
            });
            updateSummary();
        };

        // --- 3. Data Logic ---
        function addEntry() {
            const labelIn = document.getElementById('labelInput');
            const valueIn = document.getElementById('valueInput');
            const label = labelIn.value.trim();
            const value = parseFloat(valueIn.value);

            if (label && !isNaN(value) && value > 0) {
                userEntries.labels.push(label);
                userEntries.values.push(value);
                updateListUI();
                renderChart();
                labelIn.value = '';
                valueIn.value = '';
                labelIn.focus();
            } else {
                alert("Please enter a label and positive value.");
            }
        }

        function removeEntry(index) {
            userEntries.labels.splice(index, 1);
            userEntries.values.splice(index, 1);
            updateListUI();
            renderChart();
        }

        function renderChart() {
            const totalLimit = parseFloat(document.getElementById('totalInput').value);
            const currentSum = userEntries.values.reduce((a, b) => a + b, 0);

            let displayLabels = [...userEntries.labels];
            let displayValues = [...userEntries.values];
            let displayColors = [...libraPalette];

            // Undefined / Remaining Logic
            if (!isNaN(totalLimit) && totalLimit > 0) {
                const remainder = totalLimit - currentSum;
                if (remainder > 0) {
                    displayLabels.push("Remaining");
                    displayValues.push(remainder);
                    
                    // Pad colors to ensure last one is gray
                    while(displayColors.length < userEntries.values.length) {
                        displayColors = displayColors.concat(libraPalette);
                    }
                    displayColors = displayColors.slice(0, userEntries.values.length);
                    displayColors.push(undefinedColor);
                }
            }

            chartInstance.data.labels = displayLabels;
            chartInstance.data.datasets = [{
                data: displayValues,
                backgroundColor: displayColors,
                borderWidth: 1,
                borderColor: '#fff'
            }];
            chartInstance.update();
            updateSummary(totalLimit, currentSum);
        }

        function updateListUI() {
            const container = document.getElementById('listContent');
            if (userEntries.labels.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#ccc; margin-top:10px;">Empty</div>';
                return;
            }
            let html = '';
            userEntries.labels.forEach((lbl, index) => {
                html += `
                <div class="data-item">
                    <span style="font-weight:bold; color:#555;">${lbl}</span>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span>${userEntries.values[index]}</span>
                        <button class="btn-remove" onclick="removeEntry(${index})">Ã—</button>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function updateSummary(total, sum) {
            const el = document.getElementById('statsSummary');
            if (!total || isNaN(total)) {
                el.innerHTML = sum > 0 ? `Total: <span>${sum}</span>` : `Enter data to begin.`;
                return;
            }
            const remainder = total - sum;
            const statusColor = remainder >= 0 ? '#7B9ACC' : '#E57373';
            const statusText = remainder >= 0 ? 'Remaining' : 'Over Limit';
            
            el.innerHTML = `
                Used: <b>${sum}</b> / <b>${total}</b>
                <br>
                <span style="color:${statusColor}">${statusText}: ${Math.abs(remainder)}</span>
            `;
        }

        function resetAll() {
            userEntries = { labels: [], values: [] };
            document.getElementById('labelInput').value = '';
            document.getElementById('valueInput').value = '';
            document.getElementById('totalInput').value = '';
            updateListUI();
            renderChart();
        }

        function toggleType(type) {
            currentType = type;
            chartInstance.config.type = type;
            chartInstance.update();
        }

        // --- 4. Professional PDF Export ---
        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const content = document.getElementById('dashboardContent');
            const header = document.getElementById('topHeader');
            
            // Visual feedback
            const btn = document.querySelector('.btn-pdf');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Generating...';

            // Capture the whole container
            // We use scale: 2 for better resolution
            const canvas = await html2canvas(content, { scale: 2, backgroundColor: '#F5F7FA' });
            
            const imgData = canvas.toDataURL('image/png');
            
            // A4 dimensions in mm
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            
            // Add Title Header manually to PDF for crisp text
            pdf.setFont('times', 'bold');
            pdf.setFontSize(22);
            pdf.setTextColor(44, 62, 80);
            pdf.text("Libra Analytics Report", 15, 20);
            
            pdf.setFontSize(10);
            pdf.setTextColor(100);
            const date = new Date().toLocaleDateString();
            pdf.text(`Generated on: ${date}`, 15, 26);
            
            // Add the dashboard image below the header
            const imgWidth = pageWidth - 30; // 15mm margin on each side
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            pdf.addImage(imgData, 'PNG', 15, 35, imgWidth, imgHeight);
            
            // Save
            pdf.save('libra-analytics-report.pdf');

            // Reset button
            btn.innerHTML = originalText;
        }
    </script>
</body>
</html>